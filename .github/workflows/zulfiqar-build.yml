name: Zulfiqar OS Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest

    steps:
    - name: Update system
      run: pacman -Syu --noconfirm

    - name: Install base dependencies
      run: pacman -S --noconfirm base-devel git sudo pacman-contrib gnupg

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup builder user
      run: |
        useradd -m builder
        echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
        chown -R builder:builder "$GITHUB_WORKSPACE"
        chmod -R u+rwX "$GITHUB_WORKSPACE"

    - name: Install yay (AUR helper)
      run: |
        git clone https://aur.archlinux.org/yay.git /tmp/yay
        chown -R builder:builder /tmp/yay
        cd /tmp/yay
        sudo -u builder makepkg -fs --noconfirm
        sudo pacman -U --noconfirm yay-*.pkg.tar.zst

    - name: Build packages
      run: |
        mkdir -p "$GITHUB_WORKSPACE/artifacts"
        chmod -R u+rwx "$GITHUB_WORKSPACE/artifacts"
        > "$GITHUB_WORKSPACE/build-failures.txt"

        for pkg in "$GITHUB_WORKSPACE/packages/"*/; do
          if [ -f "$pkg/PKGBUILD" ]; then
            pkg_name=$(basename "$pkg")
            echo "Building $pkg_name..."
            
            # Ensure builder has write permissions
            chown -R builder:builder "$pkg"
            chmod -R u+rwX "$pkg"
            
            cd "$pkg"
            
            if sudo -u builder makepkg -fs --noconfirm 2>&1; then
              echo "✓ Build successful: $pkg_name"
              mv *.pkg.tar.zst "$GITHUB_WORKSPACE/artifacts/" 2>/dev/null || true
            else
              echo "✗ Build failed: $pkg_name" | tee -a "$GITHUB_WORKSPACE/build-failures.txt"
            fi
            
            # Cleanup to save disk space
            cd "$GITHUB_WORKSPACE"
            rm -rf "$pkg/src" "$pkg/pkg" 2>/dev/null || true
            pacman -Scc --noconfirm 2>/dev/null || true
            rm -rf /tmp/* 2>/dev/null || true
            
            echo "Disk usage: $(df -h / | tail -1 | awk '{print $5}' ) used"
          fi
        done

    - name: Create repository database
      run: |
        cd "$GITHUB_WORKSPACE/artifacts"
        chmod -R u+rwx "$GITHUB_WORKSPACE/artifacts"
        if ls *.pkg.tar.zst 1>/dev/null 2>&1; then
          repo-add -n -R zulfiqar.db.tar.gz *.pkg.tar.zst
        else
          echo "No packages built, skipping repo-add."
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: zulfiqar-packages
        path: |
          artifacts/
          build-failures.txt
