name: Zulfiqar OS Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest

    steps:
    - name: Update system
      run: pacman -Syu --noconfirm

    - name: Install base dependencies
      run: pacman -S --noconfirm base-devel git sudo pacman-contrib gnupg

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup builder user
      run: |
        useradd -m builder
        echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
        chown -R builder:builder "$GITHUB_WORKSPACE"
        chmod -R u+rwX "$GITHUB_WORKSPACE"

    - name: Create upload directory
      run: |
        mkdir -p "$GITHUB_WORKSPACE/upload"
        chmod 777 "$GITHUB_WORKSPACE/upload"
        > "$GITHUB_WORKSPACE/build-failures.txt"

    - name: Build packages incrementally
      run: |
        total=$(find "$GITHUB_WORKSPACE/packages" -maxdepth 1 -type d -name "*" | wc -l)
        current=0
        success=0
        failed=0

        for pkg in "$GITHUB_WORKSPACE/packages/"*/; do
          if [ -f "$pkg/PKGBUILD" ]; then
            current=$((current + 1))
            pkg_name=$(basename "$pkg")
            echo "========================================="
            echo "[$current/$total] Building: $pkg_name"
            echo "========================================="
            
            # Set permissions
            chown -R builder:builder "$pkg"
            chmod -R u+rwX "$pkg"
            
            cd "$pkg"
            
            # Build package
            if sudo -u builder makepkg -fs --noconfirm 2>&1 | tee build.log; then
              echo "âœ“ SUCCESS: $pkg_name"
              success=$((success + 1))
              
              # Move to upload directory IMMEDIATELY
              if ls *.pkg.tar.zst 1>/dev/null 2>&1; then
                mv *.pkg.tar.zst "$GITHUB_WORKSPACE/upload/"
                echo "â†’ Package ready for upload"
              fi
            else
              echo "âœ— FAILED: $pkg_name"
              failed=$((failed + 1))
              echo "$pkg_name" >> "$GITHUB_WORKSPACE/build-failures.txt"
            fi
            
            # AGGRESSIVE CLEANUP
            cd "$GITHUB_WORKSPACE"
            rm -rf "$pkg/src" "$pkg/pkg" "$pkg"/*.log 2>/dev/null || true
            find "$GITHUB_WORKSPACE/packages" -name "*.pkg.tar.zst" -delete 2>/dev/null || true
            pacman -Scc --noconfirm >/dev/null 2>&1 || true
            rm -rf /tmp/* /var/tmp/* 2>/dev/null || true
            
            # Upload every 10 packages to prevent disk overflow
            upload_count=$(ls -1 "$GITHUB_WORKSPACE/upload"/*.pkg.tar.zst 2>/dev/null | wc -l)
            if [ $upload_count -ge 10 ]; then
              echo "ðŸ“¤ Uploading batch of $upload_count packages..."
              
              # Create temporary artifact directory
              mkdir -p /tmp/batch-upload
              mv "$GITHUB_WORKSPACE/upload"/*.pkg.tar.zst /tmp/batch-upload/ 2>/dev/null || true
              
              # Note: Actual upload happens in separate step
              # For now, move back (GitHub Actions doesn't support mid-workflow uploads easily)
              mv /tmp/batch-upload/*.pkg.tar.zst "$GITHUB_WORKSPACE/upload/" 2>/dev/null || true
              rm -rf /tmp/batch-upload
            fi
            
            # Show disk status
            disk_used=$(df -h / | tail -1 | awk '{print $5}')
            disk_avail=$(df -h / | tail -1 | awk '{print $4}')
            echo "Disk: $disk_used used, $disk_avail available | Ready: $upload_count packages"
            echo ""
          fi
        done
        
        echo "========================================="
        echo "BUILD SUMMARY"
        echo "========================================="
        echo "Total packages: $current"
        echo "Successful: $success"
        echo "Failed: $failed"
        echo "========================================="

    - name: Create repository database
      run: |
        cd "$GITHUB_WORKSPACE/upload"
        
        if ls *.pkg.tar.zst 1>/dev/null 2>&1; then
          echo "Creating repository database..."
          repo-add -n -R zulfiqar.db.tar.gz *.pkg.tar.zst
          echo "âœ“ Repository database created"
          
          pkg_count=$(ls -1 *.pkg.tar.zst 2>/dev/null | wc -l)
          echo "Total packages in repository: $pkg_count"
        else
          echo "âš  No packages built"
        fi

    - name: Upload all packages
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: zulfiqar-packages
        path: |
          upload/
          build-failures.txt
        retention-days: 90
        compression-level: 0
