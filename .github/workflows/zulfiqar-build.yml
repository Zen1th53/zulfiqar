name: Zulfiqar OS Build (Batched)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      batch_number:
        description: 'Batch number to build (1-64)'
        required: false
        default: '1'

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Generate batch matrix
        id: set-matrix
        run: |
          # Count total packages
          total=$(find packages -maxdepth 1 -type d | tail -n +2 | wc -l)
          batch_size=50
          batches=$(( (total + batch_size - 1) / batch_size ))
          
          echo "Total packages: $total"
          echo "Batches needed: $batches"
          
          # Generate matrix (limit to first 10 batches for now to avoid too many jobs)
          matrix="["
          for i in $(seq 1 $batches); do
            if [ $i -le 10 ]; then
              matrix="$matrix$i,"
            fi
          done
          matrix="${matrix%,}]"
          
          echo "matrix=$matrix" >> $GITHUB_OUTPUT
          echo "Generated matrix: $matrix"

  build:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 3  # Build 3 batches at a time
      fail-fast: false
      matrix:
        batch: ${{fromJson(needs.prepare.outputs.matrix)}}
    
    container:
      image: archlinux:latest

    steps:
    - name: Update system
      run: pacman -Syu --noconfirm

    - name: Install base dependencies
      run: pacman -S --noconfirm base-devel git sudo pacman-contrib gnupg

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup builder user
      run: |
        useradd -m builder
        echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
        chown -R builder:builder "$GITHUB_WORKSPACE"
        chmod -R u+rwX "$GITHUB_WORKSPACE"

    - name: Build batch ${{ matrix.batch }}
      run: |
        batch_num=${{ matrix.batch }}
        batch_size=50
        start=$(( (batch_num - 1) * batch_size + 1 ))
        end=$(( batch_num * batch_size ))
        
        mkdir -p "$GITHUB_WORKSPACE/artifacts"
        chmod 777 "$GITHUB_WORKSPACE/artifacts"
        > "$GITHUB_WORKSPACE/build-failures.txt"
        
        echo "========================================="
        echo "BATCH $batch_num: Building packages $start to $end"
        echo "========================================="
        
        # Get all package directories
        all_pkgs=($(find "$GITHUB_WORKSPACE/packages" -maxdepth 1 -type d -name "*" | sort))
        
        current=0
        success=0
        failed=0
        
        for pkg in "${all_pkgs[@]}"; do
          current=$((current + 1))
          
          # Skip if not in this batch
          if [ $current -lt $start ] || [ $current -gt $end ]; then
            continue
          fi
          
          if [ -f "$pkg/PKGBUILD" ]; then
            pkg_name=$(basename "$pkg")
            echo "========================================="
            echo "[$current] Building: $pkg_name"
            echo "========================================="
            
            chown -R builder:builder "$pkg"
            chmod -R u+rwX "$pkg"
            cd "$pkg"
            
            if sudo -u builder makepkg -fs --noconfirm 2>&1 | tee build.log; then
              echo "✓ SUCCESS: $pkg_name"
              success=$((success + 1))
              
              if ls *.pkg.tar.zst 1>/dev/null 2>&1; then
                mv *.pkg.tar.zst "$GITHUB_WORKSPACE/artifacts/"
                echo "→ Package moved to artifacts"
              fi
            else
              echo "✗ FAILED: $pkg_name"
              failed=$((failed + 1))
              echo "$pkg_name" >> "$GITHUB_WORKSPACE/build-failures.txt"
            fi
            
            # Cleanup
            cd "$GITHUB_WORKSPACE"
            rm -rf "$pkg/src" "$pkg/pkg" "$pkg"/*.log 2>/dev/null || true
            find "$GITHUB_WORKSPACE/packages" -name "*.pkg.tar.zst" -delete 2>/dev/null || true
            pacman -Scc --noconfirm >/dev/null 2>&1 || true
            rm -rf /tmp/* /var/tmp/* 2>/dev/null || true
            
            disk_used=$(df -h / | tail -1 | awk '{print $5}')
            disk_avail=$(df -h / | tail -1 | awk '{print $4}')
            echo "Disk: $disk_used used, $disk_avail available"
            echo ""
          fi
        done
        
        echo "========================================="
        echo "BATCH $batch_num SUMMARY"
        echo "========================================="
        echo "Successful: $success"
        echo "Failed: $failed"
        echo "========================================="

    - name: Create repository database for batch
      run: |
        cd "$GITHUB_WORKSPACE/artifacts"
        
        if ls *.pkg.tar.zst 1>/dev/null 2>&1; then
          repo-add -n -R zulfiqar-batch${{ matrix.batch }}.db.tar.gz *.pkg.tar.zst
          pkg_count=$(ls -1 *.pkg.tar.zst 2>/dev/null | wc -l)
          echo "✓ Batch ${{ matrix.batch }}: $pkg_count packages"
        fi

    - name: Upload batch artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: zulfiqar-batch-${{ matrix.batch }}
        path: |
          artifacts/
          build-failures.txt
        retention-days: 90
