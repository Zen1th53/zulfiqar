name: Zulfiqar OS Build

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest

    steps:
    - name: Update System
      run: pacman -Syu --noconfirm

    - name: Install Dependencies
      run: pacman -S --noconfirm base-devel git sudo

    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Configure Build User
      run: |
        useradd -m builder
        echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
        chown -R builder:builder .

    - name: Build Packages
      run: |
        mkdir -p artifacts
        chown builder:builder artifacts
        su builder -c "scripts/babuild -a x86_64 -o artifacts"
        
    - name: Create Repository Database
      run: |
        cd artifacts
        # Check if any packages were built before running repo-add
        if ls *.pkg.tar.zst 1> /dev/null 2>&1; then
          repo-add zulfiqar.db.tar.gz *.pkg.tar.zst
        else
          echo "No packages built, skipping repo-add"
        fi

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: zulfiqar-packages
        path: artifacts/
